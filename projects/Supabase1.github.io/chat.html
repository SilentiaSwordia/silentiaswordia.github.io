<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Supabase demo ‚Äî Meldinger</title>

    <!-- Laster Bootstrap for enkel styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Toppfelt med tittel -->
    <nav
      class="navbar navbar-expand-md navbar-dark bg-black border-bottom"
      aria-label="Hovednavigasjon"
    >
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand fw-semibold text-white" href="index.html"
          >Innloggingsside</a
        >
        <div class="closer">
          <a class="nav-link d-inline-block text-white" href="chat.html"
            >Chat</a
          >
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <header class="text-center mb-4">
        <h1 class="h4 fw-bold">Navn + kort melding</h1>
        <p class="text-muted mb-0">Skriver til databasen og viser under.</p>
      </header>

      <!-- Skjema for innsending av navn og melding -->
      <section class="row g-4">
        <div class="col-12 col-lg-5">
          <div class="card card-elev shadow-sm">
            <div class="card-body">
              <h2 class="h6 mb-3">Send inn</h2>
              <div id="captcha" class="mb-3">
                <label
                  class="form-label"
                  for="captcha-answer"
                  id="captcha-label"
                  >Hva heter den eneste jenta i 2IM?</label
                >
                <input id="captcha-answer" class="form-control" type="text" />
                <button
                  id="captcha-check"
                  class="btn btn-secondary mt-2"
                  type="button"
                >
                  Sjekk svar
                </button>
              </div>
              <form id="form" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label class="form-label" for="name">Navn</label>
                  <input
                    id="name"
                    class="form-control"
                    minlength="2"
                    maxlength="30"
                    required
                    placeholder="F.eks. Sara"
                  />
                  <div class="invalid-feedback">
                    Skriv inn navnet ditt (2‚Äì30 tegn).
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label" for="content">Kort melding</label>
                  <input
                    id="content"
                    class="form-control"
                    maxlength="140"
                    required
                    placeholder="Hei verden! (maks 140 tegn)"
                  />
                  <div class="invalid-feedback">
                    Skriv en kort melding (maks 140 tegn).
                  </div>
                </div>
                <button class="btn btn-primary w-100" type="submit">
                  Lagre
                </button>
                <div id="status" class="form-text mt-2 muted">Klar</div>
              </form>
            </div>
          </div>
        </div>

        <!-- Omr√•de for √• vise alle meldinger -->
        <div class="col-12 col-lg-7">
          <div class="card card-elev shadow-sm">
            <div class="card-body">
              <div
                class="d-flex align-items-center justify-content-between mb-2"
              >
                <h2 class="h6 mb-0">Meldinger</h2>
                <span class="badge text-bg-light"
                  ><span id="count">0</span> stk</span
                >
              </div>
              <div id="msgs" class="d-grid gap-2"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Laster Supabase-biblioteket som gj√∏r det mulig √• kommunisere med databasen -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <!-- Fallback: load ESM createClient and expose it as a global for older pages -->
    <script type="module">
      try {
        const mod = await import(
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
        );
        if (mod && typeof mod.createClient === "function") {
          // Expose a global createClient so the non-module init code can use it
          window.createClient = mod.createClient;
          window.supabase = window.supabase || {
            createClient: mod.createClient,
          };
          console.info(
            "Supabase ESM loaded and createClient exposed as global"
          );
        }
      } catch (e) {
        console.warn("Supabase ESM loader failed:", e);
      }
    </script>

    <!-- Her starter v√•rt eget JavaScript -->
    <script>
      // üîë Koble nettsiden til ditt Supabase-prosjekt, bytt ut det i r√∏d tekst med dine verdier ‚ö†Ô∏è
      const SUPABASE_URL = "https://tbywtsnllvkoiuxnxjpq.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRieXd0c25sbHZrb2l1eG54anBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDc0MDEsImV4cCI6MjA3Njc4MzQwMX0.RvPYOW13Ypmi10zSyPDJgITdzHZpil2FBS6E7GzIWvs";

      // Supabase client will be set once available (ESM loader may be async).
      let supabase = null;

      // Poll for a global `createClient`/`supabase.createClient` that the CDN or ESM loader may expose.
      async function waitForCreateClient(timeout = 3000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
          try {
            if (
              window.supabase &&
              typeof window.supabase.createClient === "function"
            ) {
              return window.supabase.createClient(
                SUPABASE_URL,
                SUPABASE_ANON_KEY
              );
            }
            if (typeof window.createClient === "function") {
              return window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            if (
              window.Supabase &&
              typeof window.Supabase.createClient === "function"
            ) {
              return window.Supabase.createClient(
                SUPABASE_URL,
                SUPABASE_ANON_KEY
              );
            }
          } catch (e) {
            console.debug("Supabase check error:", e);
          }
          await new Promise((r) => setTimeout(r, 50));
        }
        return null;
      }

      // Try to initialize soon after load; if initialized, load messages automatically.
      (async () => {
        const statusElFallback = document.getElementById("status");
        if (statusElFallback)
          statusElFallback.textContent = "Initierer tilkobling...";
        supabase = await waitForCreateClient(3000);
        if (supabase) {
          console.info("Supabase client initialised");
          if (statusElFallback)
            statusElFallback.textContent = "Koblet til Supabase.";
          try {
            await loadMessages();
          } catch (e) {
            console.error("Error loading messages after init:", e);
          }
        } else {
          console.error("Supabase init error: library not found after timeout");
          if (statusElFallback)
            statusElFallback.textContent =
              "Feil: Supabase-biblioteket ikke lastet. Sjekk konsollen.";
        }
      })();

      // Henter elementene fra skjemaet og siden
      const form = document.getElementById("form");
      const nameInput = document.getElementById("name");
      const contentInput = document.getElementById("content");
      const msgsEl = document.getElementById("msgs");
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const captchaInput = document.getElementById("captcha-answer");
      const captchaCheckBtn = document.getElementById("captcha-check");
      const submitBtn = form.querySelector('button[type="submit"]');

      // Disable form submission initially
      submitBtn.disabled = true;

      captchaCheckBtn.addEventListener("click", () => {
        if (captchaInput.value.trim().toLowerCase() === "anmol") {
          document.getElementById("captcha").style.display = "none";
          submitBtn.disabled = false;
          statusEl.textContent = "Du kan n√• sende meldinger.";
        } else {
          statusEl.textContent = "Feil svar, pr√∏v igjen.";
        }
      });

      // Gj√∏r tekst trygg for visning (hindrer HTML-injeksjon)
      function esc(s) {
        return String(s || "").replace(/[<>&"']/g, function (c) {
          return { "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c];
        });
      }

      // Deler opp meldingen i navn og tekst
      function parseRow(r) {
        const raw = r.content || "";
        const i = raw.indexOf("::");
        return i === -1
          ? { name: "Anonym", message: raw, created_at: r.created_at }
          : {
              name: raw.slice(0, i),
              message: raw.slice(i + 2),
              created_at: r.created_at,
            };
      }

      // Leser meldinger fra databasen og viser dem
      async function loadMessages() {
        statusEl.textContent = "Laster...";
        if (!supabase) {
          statusEl.textContent =
            "Ingen database-tilkobling (Supabase ikke lastet).";
          return;
        }
        const { data, error } = await supabase
          .from("messages")
          .select("*")
          .order("created_at", { ascending: false })
          .limit(100);
        if (error) {
          statusEl.textContent = "Feil: " + error.message;
          return;
        }
        countEl.textContent = (data || []).length;
        msgsEl.innerHTML = (data || [])
          .map((r) => {
            const it = parseRow(r);
            const when = new Date(it.created_at).toLocaleString();
            return `<div class="p-2 border-bottom"><strong>${esc(
              it.name
            )}</strong>: ${esc(
              it.message
            )} <span class="text-muted small">${when}</span></div>`;
          })
          .join("");
        statusEl.textContent = "Klar";
      }

      // Sender inn ny melding n√•r eleven trykker "Lagre"
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        form.classList.add("was-validated");
        if (!form.checkValidity()) return;

        const name = nameInput.value.trim();
        const msg = contentInput.value.trim();
        if (!name || !msg) return;

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        statusEl.textContent = "Lagrer...";

        // Sender data til Supabase-tabellen "messages"
        if (!supabase) {
          statusEl.textContent =
            "Kan ikke sende: ingen DB-tilkobling (Supabase ikke lastet).";
          submitBtn.disabled = false;
          return;
        }
        const { error } = await supabase
          .from("messages")
          .insert({ content: name + "::" + msg });

        submitBtn.disabled = false;

        if (error) {
          statusEl.textContent = "Feil ved lagring: " + error.message;
          return;
        }

        // Nullstiller skjema og fjerner valideringsklassen
        form.reset();
        form.classList.remove("was-validated");
        statusEl.textContent = "Lagret!";
        nameInput.focus();

        // Oppdaterer visningen
        await loadMessages();
      });

      // Kj√∏rer f√∏rste opplasting av meldinger n√•r siden lastes
      loadMessages();
    </script>
    <div class="position-fixed bottom-0 start-0 p-3" style="z-index: 1080">
      <a href="../../index.html" class="btn btn-primary">&larr; Back to Home</a>
    </div>
  </body>
</html>
